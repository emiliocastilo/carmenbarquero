const coordenadas={nombre:{x:210,y:581},dni:{x:158,y:566},dia:{x:212,y:550},mes:{x:242,y:550},anio:{x:272,y:550},telefono:{x:215,y:535},lugar:{x:124,y:565},firmaFechaDia:{x:238,y:565},firmaFechaMes:{x:275,y:565},firmaFechaAnio:{x:365,y:565},firmaImagen:{x:115,y:455}};function tieneCanvasFirma(){const e=document.getElementById("canvas-firma");if(!e)return!1;const o=e.getContext("2d").getImageData(0,0,e.width,e.height).data;for(let e=3;e<o.length;e+=4)if(o[e]>0)return!0;return!1}function parsearFecha(e){console.log("üìÖ Parseando fecha:",e);const o=(e=e.trim()).split("/");if(3===o.length){const e=o[0].trim().padStart(2,"0"),a=o[1].trim().padStart(2,"0"),n=o[2].trim();return console.log("‚úì Fecha parseada:",{dia:e,mes:a,anio:n}),{dia:e,mes:a,anio:n}}return console.warn("‚ö†Ô∏è No se pudo parsear la fecha"),{dia:"",mes:"",anio:""}}function validarFormulario(){const e={"nombre-apellidos":"Nombre y apellidos",dni:"DNI/NIE",telefono:"Tel√©fono",lugar:"Lugar (ciudad)"},o=[];for(const[a,n]of Object.entries(e)){const e=document.getElementById(a);e&&e.value.trim()?e?.classList.remove("campo-error"):(o.push(n),e?.classList.add("campo-error"))}const a=document.getElementById("fecha-nacimiento-dia"),n=document.getElementById("fecha-nacimiento-mes"),t=document.getElementById("fecha-nacimiento-anio");a?.value&&n?.value&&t?.value?(a?.classList.remove("campo-error"),n?.classList.remove("campo-error"),t?.classList.remove("campo-error")):(o.push("Fecha de nacimiento"),a?.classList.add("campo-error"),n?.classList.add("campo-error"),t?.classList.add("campo-error")),tieneCanvasFirma()||o.push("Firma manuscrita");const r=document.getElementById("errores-validacion");return o.length>0?(r.innerHTML=`\n      <strong>‚ö†Ô∏è Faltan campos por completar:</strong>\n      <ul>\n        ${o.map(e=>`<li>${e}</li>`).join("")}\n      </ul>\n    `,r.style.display="block",r.scrollIntoView({behavior:"smooth",block:"nearest"})):r.style.display="none",0===o.length}async function generatePDF(){if(console.log("üöÄ Iniciando generaci√≥n de PDF..."),!validarFormulario())return void console.log("‚ùå Validaci√≥n fallida");const e=document.getElementById("btn-confirmar"),o=e.innerHTML;e.innerHTML='<span class="spinner"></span> Generando PDF...',e.disabled=!0;try{const{PDFDocument:e}=PDFLib;console.log("‚úì PDFLib cargado");const o={nombreApellidos:document.getElementById("nombre-apellidos")?.value||"",dni:document.getElementById("dni")?.value||"",telefono:document.getElementById("telefono")?.value||"",lugar:document.getElementById("lugar")?.value||""};console.log("üìã Datos del formulario:",o);const a={dia:document.getElementById("fecha-nacimiento-dia")?.value||"",mes:document.getElementById("fecha-nacimiento-mes")?.value||"",anio:document.getElementById("fecha-nacimiento-anio")?.value||""};console.log("üìÖ Fecha de nacimiento:",a);const n="www.carmenbarqueropsicologia.es"===window.location.hostname||"carmenbarqueropsicologia.es"===window.location.hostname?"https://www.carmenbarqueropsicologia.es/consentimiento-informado-template.pdf":"docs/consentimiento-informado-template.pdf";console.log("üîó Cargando PDF desde:",n);const t=await fetch(n);if(!t.ok)throw new Error("No se pudo cargar el PDF original (status: "+t.status+")");const r=await t.arrayBuffer(),i=await e.load(r);console.log("‚úì PDF cargado correctamente"),await rellenarPDFOriginal(i,o,a);const s=await i.save();console.log("‚úì PDF guardado, size:",s.length,"bytes"),descargarPDF(s,o.nombreApellidos),mostrarMensajeExito()}catch(e){console.error("‚ùå Error al generar PDF:",e);const o=document.getElementById("errores-validacion");o.innerHTML=`<strong>‚ùå Error:</strong> ${e.message}`,o.style.display="block"}finally{e.innerHTML=o,e.disabled=!1}}async function rellenarPDFOriginal(e,o,a){try{const n=e.getForm(),t=n.getFields();if(console.log("üîç Campos encontrados en el PDF:",t.map(e=>e.getName())),t.length>0){const e=[{patrones:["nombre","apellidos","paciente","persona","usuario"],valor:o.nombreApellidos},{patrones:["dni","nie","documento","identidad"],valor:o.dni},{patrones:["nacimiento","birth"],valor:o.fechaNacimiento},{patrones:["telefono","phone","movil","contacto"],valor:o.telefono},{patrones:["ciudad","lugar","localidad"],valor:o.lugar},{patrones:["dia","day"],valor:a.dia},{patrones:["mes","month"],valor:a.mes},{patrones:["a√±o","anio","year"],valor:a.anio}];t.forEach(o=>{const a=o.getName().toLowerCase();for(const n of e)if(n.patrones.some(e=>a.includes(e))){try{"function"==typeof o.setText&&n.valor&&(o.setText(n.valor),console.log(`‚úì Campo rellenado: ${o.getName()} = ${n.valor}`))}catch(e){console.log(`‚ö†Ô∏è No se pudo rellenar el campo ${o.getName()}`)}break}});try{n.flatten(),console.log("‚úì Formulario aplanado")}catch(e){console.log("‚ö†Ô∏è No se pudo aplanar el formulario")}}else console.log("üìù Sin campos AcroForm, escribiendo directamente..."),await escribirDatosDirectamente(e,o,a);await anadirFirma(e)}catch(n){console.error("‚ùå Error en rellenarPDFOriginal:",n),console.log("üìù Intentando escribir directamente..."),await escribirDatosDirectamente(e,o,a),await anadirFirma(e)}}async function escribirDatosDirectamente(e,o,a){const{rgb:n,StandardFonts:t}=PDFLib;try{const r=await e.embedFont(t.Helvetica),i=e.getPages();if(console.log("üìÑ Total de p√°ginas:",i.length),i.length>0){const e=i[0],{height:t,width:s}=e.getSize(),c=11,d=n(0,0,0);console.log("üìê P√°gina 1 - Dimensiones:",{width:s,height:t}),console.log("üìç Usando coordenadas:",coordenadas),o.nombreApellidos&&(e.drawText(o.nombreApellidos,{x:coordenadas.nombre.x,y:coordenadas.nombre.y,size:c,font:r,color:d}),console.log("‚úì Nombre escrito:",o.nombreApellidos,"en",coordenadas.nombre)),o.dni&&(e.drawText(o.dni,{x:coordenadas.dni.x,y:coordenadas.dni.y,size:c,font:r,color:d}),console.log("‚úì DNI escrito:",o.dni,"en",coordenadas.dni)),a.dia&&(e.drawText(a.dia,{x:coordenadas.dia.x,y:coordenadas.dia.y,size:c,font:r,color:d}),console.log("‚úì D√≠a escrito:",a.dia,"en",coordenadas.dia)),a.mes&&(e.drawText(a.mes,{x:coordenadas.mes.x,y:coordenadas.mes.y,size:c,font:r,color:d}),console.log("‚úì Mes escrito:",a.mes,"en",coordenadas.mes)),a.anio&&(e.drawText(a.anio,{x:coordenadas.anio.x,y:coordenadas.anio.y,size:c,font:r,color:d}),console.log("‚úì A√±o escrito:",a.anio,"en",coordenadas.anio)),o.telefono&&(e.drawText(o.telefono,{x:coordenadas.telefono.x,y:coordenadas.telefono.y,size:c,font:r,color:d}),console.log("‚úì Tel√©fono escrito:",o.telefono,"en",coordenadas.telefono)),console.log("‚úì P√°gina 1 completada")}if(i.length>2){const e=i[2],{height:a}=e.getSize(),t=11,s=n(0,0,0);o.lugar&&(e.drawText(o.lugar,{x:coordenadas.lugar.x,y:coordenadas.lugar.y,size:t,font:r,color:s}),console.log("‚úì Lugar escrito:",o.lugar,"en",coordenadas.lugar));const c=document.getElementById("dia")?.value||"",d=document.getElementById("mes")?.value||"",l=document.getElementById("anio")?.value||"";e.drawText(c,{x:coordenadas.firmaFechaDia.x,y:coordenadas.firmaFechaDia.y,size:t,font:r,color:s}),console.log("‚úì D√≠a firma escrito:",c,"en",coordenadas.firmaFechaDia),e.drawText(d,{x:coordenadas.firmaFechaMes.x,y:coordenadas.firmaFechaMes.y,size:t,font:r,color:s}),console.log("‚úì Mes firma escrito:",d,"en",coordenadas.firmaFechaMes),e.drawText(l,{x:coordenadas.firmaFechaAnio.x,y:coordenadas.firmaFechaAnio.y,size:t,font:r,color:s}),console.log("‚úì A√±o firma escrito:",l,"en",coordenadas.firmaFechaAnio),console.log("‚úì P√°gina 3 completada")}console.log("‚úì‚úì‚úì Todos los datos escritos correctamente ‚úì‚úì‚úì")}catch(e){throw console.error("‚ùå Error escribiendo datos directamente:",e),e}}async function anadirFirma(e){const o=document.getElementById("canvas-firma");if(o&&tieneCanvasFirma())try{const a=o.toDataURL("image/png"),n=await fetch(a).then(e=>e.arrayBuffer()),t=await e.embedPng(n),r=e.getPages();if(r.length>2){const e=r[2],{height:o}=e.getSize(),a=180,n=60,i=Math.min(a/t.width,n/t.height),s=t.width*i,c=t.height*i;e.drawImage(t,{x:coordenadas.firmaImagen.x,y:coordenadas.firmaImagen.y,width:s,height:c}),console.log("‚úì Firma a√±adida al PDF en",coordenadas.firmaImagen)}}catch(e){console.log("‚ùå Error al a√±adir firma:",e)}else console.log("‚ö†Ô∏è No hay firma para a√±adir")}function descargarPDF(e,o){const a=new Blob([e],{type:"application/pdf"}),n=URL.createObjectURL(a),t=document.createElement("a");t.href=n;const r=o?`consentimiento-${o.replace(/\s+/g,"-").toLowerCase()}.pdf`:"consentimiento-informado.pdf";t.download=r,document.body.appendChild(t),t.click(),document.body.removeChild(t),URL.revokeObjectURL(n),console.log("üì• Descarga iniciada:",r)}function mostrarMensajeExito(){const e=document.createElement("div");e.className="mensaje-exito",e.innerHTML='\n    <div class="mensaje-exito-content">\n      <span class="mensaje-exito-icon">‚úì</span>\n      <p>¬°PDF generado correctamente!</p>\n      <p class="mensaje-exito-sub">El documento se ha descargado en tu dispositivo.</p>\n    </div>\n  ',document.body.appendChild(e),setTimeout(()=>{e.classList.add("mensaje-exito-fade"),setTimeout(()=>e.remove(),500)},3e3)}window.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("canvas-firma");if(!e)return;const o=e.getContext("2d");let a=!1;function n(o){const a=e.getBoundingClientRect(),n=e.width/a.width,t=e.height/a.height;return{x:((o.touches?o.touches[0].clientX:o.clientX)-a.left)*n,y:((o.touches?o.touches[0].clientY:o.clientY)-a.top)*t}}o.strokeStyle="#1a1a1a",o.lineWidth=2,o.lineCap="round",o.lineJoin="round",e.addEventListener("mousedown",e=>{a=!0;const t=n(e);o.beginPath(),o.moveTo(t.x,t.y)}),e.addEventListener("mousemove",e=>{if(!a)return;const t=n(e);o.lineTo(t.x,t.y),o.stroke()}),e.addEventListener("mouseup",()=>a=!1),e.addEventListener("mouseleave",()=>a=!1),e.addEventListener("touchstart",e=>{e.preventDefault(),a=!0;const t=n(e);o.beginPath(),o.moveTo(t.x,t.y)},{passive:!1}),e.addEventListener("touchmove",e=>{if(!a)return;const t=n(e);o.lineTo(t.x,t.y),o.stroke(),e.preventDefault()},{passive:!1}),e.addEventListener("touchend",()=>a=!1),document.getElementById("limpiar-firma")?.addEventListener("click",function(){o.clearRect(0,0,e.width,e.height)});const t=document.getElementById("fecha-nacimiento-dia"),r=document.getElementById("fecha-nacimiento-anio");if(t)for(let e=1;e<=31;e++){const o=document.createElement("option");o.value=e.toString().padStart(2,"0"),o.textContent=e,t.appendChild(o)}if(r){for(let e=(new Date).getFullYear();e>=1920;e--){const o=document.createElement("option");o.value=e.toString(),o.textContent=e,r.appendChild(o)}}const i=new Date,s=document.getElementById("dia"),c=document.getElementById("mes"),d=document.getElementById("anio");if(s&&(s.value=i.getDate()),c){const e=["enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"];c.value=e[i.getMonth()]}d&&(d.value=i.getFullYear())}),window.generatePDF=generatePDF;