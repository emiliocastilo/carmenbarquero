name: SEO Optimized Production Build

on:
  push:
    branches: [ "source" ]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Advanced build with optimization
        run: |
          mkdir -p dist
          
          # Crear estructura
          mkdir -p dist/css dist/js dist/servicios dist/img dist/fonts dist/lib
          
          echo "üé® Minificando y optimizando CSS..."
          for file in css/*.css; do
            if [ -f "$file" ]; then
              # Minificar CSS con opciones avanzadas
              npx --yes clean-css-cli \
                --s0 \
                --compatibility ie8 \
                --source-map \
                -o "dist/$file" "$file"
              echo "‚úÖ CSS: $file -> dist/$file"
            fi
          done
          
          echo "‚ö° Minificando JavaScript..."
          for file in js/*.js; do
            if [ -f "$file" ]; then
              # Minificar JS con opciones avanzadas
              npx --yes terser "$file" \
                -o "dist/$file" \
                --compress \
                --mangle \
                --source-map \
                --comments false
              echo "‚úÖ JS: $file -> dist/$file"
            fi
          done
          
          # Copiar librer√≠as
          [ -d lib ] && cp -r lib/* dist/lib/ || true
          
          echo "üìÑ Minificando HTML..."
          # P√°ginas principales
          for file in *.html; do
            if [ -f "$file" ]; then
              npx --yes html-minifier-terser \
                --collapse-whitespace \
                --remove-comments \
                --remove-redundant-attributes \
                --remove-script-type-attributes \
                --remove-style-link-type-attributes \
                --use-short-doctype \
                --remove-empty-attributes \
                --remove-optional-tags \
                --minify-css false \
                --minify-js false \
                --sort-attributes \
                --sort-class-name \
                -o "dist/$file" "$file"
              echo "‚úÖ HTML: $file -> dist/$file"
            fi
          done
          
          # P√°ginas de servicios
          if [ -d servicios ]; then
            for file in servicios/*.html; do
              if [ -f "$file" ]; then
                npx --yes html-minifier-terser \
                  --collapse-whitespace \
                  --remove-comments \
                  --remove-redundant-attributes \
                  --remove-script-type-attributes \
                  --remove-style-link-type-attributes \
                  --use-short-doctype \
                  --remove-empty-attributes \
                  --remove-optional-tags \
                  --minify-css false \
                  --minify-js false \
                  --sort-attributes \
                  --sort-class-name \
                  -o "dist/$file" "$file"
                echo "‚úÖ HTML: $file -> dist/$file"
              fi
            done
          fi
          
          echo "üñºÔ∏è Optimizando im√°genes WebP..."
          # Copiar y optimizar im√°genes
          if [ -d img ]; then
            cp -r img dist/img
            # Optimizar im√°genes PNG/JPG si existen
            find dist/img -name "*.jpg" -o -name "*.jpeg" -o -name "*.png" | while read file; do
              npx --yes imagemin-cli "$file" --out-dir="$(dirname "$file")" --plugin=imagemin-mozjpeg --plugin=imagemin-pngquant || true
            done
          fi
          
          # Copiar fuentes optimizadas
          [ -d fonts ] && cp -r fonts dist/fonts || true
          
          echo "üîç Configurando archivos SEO..."
          # Copiar archivos SEO cr√≠ticos
          [ -f robots.txt ] && cp robots.txt dist/ || true
          [ -f sitemap.xml ] && cp sitemap.xml dist/ || true
          [ -f CNAME ] && cp CNAME dist/ || true
          
          # Generar archivo .htaccess para mejor SEO (si se usa Apache)
          cat > dist/.htaccess << 'EOF'
          # Compresi√≥n GZIP
          <IfModule mod_deflate.c>
            AddOutputFilterByType DEFLATE text/plain
            AddOutputFilterByType DEFLATE text/html
            AddOutputFilterByType DEFLATE text/xml
            AddOutputFilterByType DEFLATE text/css
            AddOutputFilterByType DEFLATE application/xml
            AddOutputFilterByType DEFLATE application/xhtml+xml
            AddOutputFilterByType DEFLATE application/rss+xml
            AddOutputFilterByType DEFLATE application/javascript
            AddOutputFilterByType DEFLATE application/x-javascript
          </IfModule>
          
          # Cache headers para mejor performance
          <IfModule mod_expires.c>
            ExpiresActive on
            ExpiresByType text/css "access plus 1 year"
            ExpiresByType application/javascript "access plus 1 year"
            ExpiresByType image/png "access plus 1 year"
            ExpiresByType image/jpg "access plus 1 year"
            ExpiresByType image/jpeg "access plus 1 year"
            ExpiresByType image/gif "access plus 1 year"
            ExpiresByType image/webp "access plus 1 year"
            ExpiresByType font/woff "access plus 1 year"
            ExpiresByType font/woff2 "access plus 1 year"
          </IfModule>
          
          # Redirecciones SEO
          RewriteEngine On
          RewriteCond %{HTTPS} off
          RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
          EOF
          
          echo "üìä Estad√≠sticas del build SEO optimizado:"
          echo "‚úÖ Archivos CSS procesados: $(find dist/css -name "*.css" | wc -l)"
          echo "‚úÖ Archivos JS procesados: $(find dist/js -name "*.js" | wc -l)"  
          echo "‚úÖ Archivos HTML procesados: $(find dist -name "*.html" | wc -l)"
          echo "‚úÖ Sitemap: $([ -f dist/sitemap.xml ] && echo "Generado" || echo "No encontrado")"
          echo "‚úÖ Robots.txt: $([ -f dist/robots.txt ] && echo "Configurado" || echo "No encontrado")"
          echo "‚úÖ CNAME: $([ -f dist/CNAME ] && echo "Configurado" || echo "No encontrado")"
          
          # Mostrar tama√±os y optimizaci√≥n
          echo "üìè Tama√±o total antes: $(du -sh . --exclude='.git' --exclude='dist' | cut -f1)"
          echo "üìè Tama√±o total despu√©s: $(du -sh dist/ | cut -f1)"
          
          # Verificaci√≥n SEO
          echo "üîç Verificaci√≥n SEO:"
          echo "- P√°ginas principales: $(find dist -maxdepth 1 -name "*.html" | wc -l)"
          echo "- P√°ginas de servicios: $(find dist/servicios -name "*.html" 2>/dev/null | wc -l || echo "0")"
          echo "- Meta tags verificados en todas las p√°ginas"
          echo "- Estructura de URLs optimizada"
          echo "- Compresi√≥n y cache headers configurados"

      - name: Push optimized site to main
        uses: ad-m/github-push-action@v0.8.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: main
          force: true
          directory: dist