name: Production Build - Simple & Reliable

on:
  push:
    branches: [ "source" ]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build and minify website
        run: |
          mkdir -p dist
          
          # Crear estructura de directorios
          mkdir -p dist/css dist/js dist/servicios dist/img dist/fonts dist/lib
          
          echo "üé® Minificando CSS..."
          for file in css/*.css; do
            if [ -f "$file" ]; then
              npx --yes clean-css-cli -o "dist/$file" "$file" || cp "$file" "dist/$file"
              echo "‚úÖ CSS procesado: $file"
            fi
          done
          
          echo "‚ö° Minificando JavaScript..."
          for file in js/*.js; do
            if [ -f "$file" ]; then
              npx --yes terser "$file" -o "dist/$file" --compress --mangle || cp "$file" "dist/$file"
              echo "‚úÖ JS procesado: $file"
            fi
          done
          
          echo "üìÑ Minificando HTML..."
          # P√°ginas principales
          for file in *.html; do
            if [ -f "$file" ]; then
              npx --yes html-minifier-terser \
                --collapse-whitespace \
                --remove-comments \
                --remove-redundant-attributes \
                --minify-css false \
                --minify-js false \
                -o "dist/$file" "$file" || cp "$file" "dist/$file"
              echo "‚úÖ HTML procesado: $file"
            fi
          done
          
          # P√°ginas de servicios
          if [ -d servicios ]; then
            for file in servicios/*.html; do
              if [ -f "$file" ]; then
                npx --yes html-minifier-terser \
                  --collapse-whitespace \
                  --remove-comments \
                  --remove-redundant-attributes \
                  --minify-css false \
                  --minify-js false \
                  -o "dist/$file" "$file" || cp "$file" "dist/$file"
                echo "‚úÖ HTML procesado: $file"
              fi
            done
          fi
          
          echo "üìÅ Copiando assets..."
          # Copiar todos los assets
          [ -d img ] && cp -r img dist/ || true
          [ -d fonts ] && cp -r fonts dist/ || true
          [ -d lib ] && cp -r lib dist/ || true
          
          # Copiar archivos de configuraci√≥n
          [ -f robots.txt ] && cp robots.txt dist/ || true
          [ -f sitemap.xml ] && cp sitemap.xml dist/ || true
          [ -f CNAME ] && cp CNAME dist/ || true
          [ -f favicon.ico ] && cp favicon.ico dist/ || true
          
          echo "üìä Build completado:"
          echo "- CSS: $(find dist/css -name "*.css" 2>/dev/null | wc -l) archivos"
          echo "- JS: $(find dist/js -name "*.js" 2>/dev/null | wc -l) archivos"
          echo "- HTML: $(find dist -name "*.html" 2>/dev/null | wc -l) p√°ginas"
          echo "- Tama√±o total: $(du -sh dist/ | cut -f1)"

      - name: Deploy to main branch
        uses: ad-m/github-push-action@v0.8.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: main
          force: true
          directory: dist