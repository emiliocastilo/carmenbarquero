name: Production Build - URLs Fixed

on:
  push:
    branches: [ "source" ]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build and minify website
        run: |
          mkdir -p dist/css dist/js dist/servicios dist/img dist/fonts
          
          echo "ðŸ”— PASO 1: Convertir URLs en archivos HTML (ANTES de minificar)"
          
          # FunciÃ³n para convertir URLs
          convert_urls_in_file() {
            local file="$1"
            echo "ðŸ”§ Procesando URLs en: $file"
            
            # URLs absolutas para recursos
            sed -i 's|href="css/|href="https://www.carmenbarqueropsicologia.es/css/|g' "$file"
            sed -i 's|src="js/|src="https://www.carmenbarqueropsicologia.es/js/|g' "$file"
            sed -i 's|src="img/|src="https://www.carmenbarqueropsicologia.es/img/|g' "$file"
            sed -i 's|srcset="img/|srcset="https://www.carmenbarqueropsicologia.es/img/|g' "$file"
            sed -i 's|href="./img/favicon/|href="https://www.carmenbarqueropsicologia.es/img/favicon/|g' "$file"
            
            # NavegaciÃ³n SIN .html
            sed -i 's|href="index\.html"|href="https://www.carmenbarqueropsicologia.es/"|g' "$file"
            sed -i 's|href="contacto\.html"|href="https://www.carmenbarqueropsicologia.es/contacto"|g' "$file"
            sed -i 's|href="reserva-cita\.html"|href="https://www.carmenbarqueropsicologia.es/reserva-cita"|g' "$file"
            sed -i 's|href="servicios/terapia-individual\.html"|href="https://www.carmenbarqueropsicologia.es/servicios/terapia-individual"|g' "$file"
            sed -i 's|href="servicios/terapia-pareja\.html"|href="https://www.carmenbarqueropsicologia.es/servicios/terapia-pareja"|g' "$file"
            sed -i 's|href="servicios/neuropsicologia-clinica\.html"|href="https://www.carmenbarqueropsicologia.es/servicios/neuropsicologia-clinica"|g' "$file"
            sed -i 's|href="politica-privacidad\.html"|href="https://www.carmenbarqueropsicologia.es/politica-privacidad"|g' "$file"
            sed -i 's|href="politica-cookies\.html"|href="https://www.carmenbarqueropsicologia.es/politica-cookies"|g' "$file"
            sed -i 's|href="aviso-legal\.html"|href="https://www.carmenbarqueropsicologia.es/aviso-legal"|g' "$file"
            sed -i 's|href="consentimientoinformado\.html"|href="https://www.carmenbarqueropsicologia.es/consentimientoinformado"|g' "$file"
            
            # Rutas relativas desde servicios/ - TODAS las variantes
            sed -i 's|href="../contacto\.html"|href="https://www.carmenbarqueropsicologia.es/contacto"|g' "$file"
            sed -i 's|href="../reserva-cita\.html"|href="https://www.carmenbarqueropsicologia.es/reserva-cita"|g' "$file"
            sed -i 's|href="../consentimientoinformado\.html"|href="https://www.carmenbarqueropsicologia.es/consentimientoinformado"|g' "$file"
            sed -i 's|href="../politica-privacidad\.html"|href="https://www.carmenbarqueropsicologia.es/politica-privacidad"|g' "$file"
            sed -i 's|href="../index\.html"|href="https://www.carmenbarqueropsicologia.es/"|g' "$file"
            
            # Enlaces entre servicios (desde servicios/ a servicios/)
            sed -i 's|href="terapia-individual\.html"|href="https://www.carmenbarqueropsicologia.es/servicios/terapia-individual"|g' "$file"
            sed -i 's|href="terapia-pareja\.html"|href="https://www.carmenbarqueropsicologia.es/servicios/terapia-pareja"|g' "$file"
            sed -i 's|href="neuropsicologia-clinica\.html"|href="https://www.carmenbarqueropsicologia.es/servicios/neuropsicologia-clinica"|g' "$file"
            
            # Canonical links - remover .html
            sed -i 's|/contacto\.html"|/contacto"|g' "$file"
            sed -i 's|/reserva-cita\.html"|/reserva-cita"|g' "$file"
            sed -i 's|/consentimientoinformado\.html"|/consentimientoinformado"|g' "$file"
            sed -i 's|/politica-privacidad\.html"|/politica-privacidad"|g' "$file"
            sed -i 's|/politica-cookies\.html"|/politica-cookies"|g' "$file"
            sed -i 's|/aviso-legal\.html"|/aviso-legal"|g' "$file"
            sed -i 's|/servicios/terapia-individual\.html"|/servicios/terapia-individual"|g' "$file"
            sed -i 's|/servicios/terapia-pareja\.html"|/servicios/terapia-pareja"|g' "$file"
            sed -i 's|/servicios/neuropsicologia-clinica\.html"|/servicios/neuropsicologia-clinica"|g' "$file"
            
            # Recursos desde servicios/
            sed -i 's|href="../css/|href="https://www.carmenbarqueropsicologia.es/css/|g' "$file"
            sed -i 's|src="../js/|src="https://www.carmenbarqueropsicologia.es/js/|g' "$file"
            sed -i 's|src="../img/|src="https://www.carmenbarqueropsicologia.es/img/|g' "$file"
            sed -i 's|srcset="../img/|srcset="https://www.carmenbarqueropsicologia.es/img/|g' "$file"
            sed -i 's|href="../img/|href="https://www.carmenbarqueropsicologia.es/img/|g' "$file"
            
            echo "âœ… URLs convertidas en: $file"
          }
          
          # Convertir URLs en archivos principales (TODAS las pÃ¡ginas HTML)
          echo "ðŸ“„ Procesando pÃ¡ginas principales:"
          for file in *.html; do
            if [ -f "$file" ] && [ "$file" != "google37cf596a386f6881.html" ]; then
              echo "ðŸ”§ Aplicando conversiÃ³n URL a: $file"
              convert_urls_in_file "$file"
            else
              echo "â­ï¸  Saltando: $file"
            fi
          done
          
          # Convertir URLs en servicios
          echo "ðŸ“ Procesando pÃ¡ginas de servicios:"
          for file in servicios/*.html; do
            if [ -f "$file" ]; then
              echo "ðŸ”§ Aplicando conversiÃ³n URL a: $file"
              convert_urls_in_file "$file"
            fi
          done
          
          echo "âœ… ConversiÃ³n de URLs completada en TODAS las pÃ¡ginas"
          
          echo "ðŸŽ¨ PASO 2: Minificar CSS"
          for file in css/*.css; do
            if [ -f "$file" ]; then
              npx --yes clean-css-cli -o "dist/$file" "$file" || cp "$file" "dist/$file"
              echo "âœ… CSS: $file"
            fi
          done
          
          echo "âš¡ PASO 3: Minificar JavaScript"
          for file in js/*.js; do
            if [ -f "$file" ]; then
              npx --yes terser "$file" -o "dist/$file" --compress --mangle || cp "$file" "dist/$file"
              echo "âœ… JS: $file"
            fi
          done
          
          echo "ðŸ“„ PASO 4: Minificar TODOS los archivos HTML (ya con URLs convertidas)"
          echo "ðŸ“‹ Archivos HTML encontrados en raÃ­z:"
          ls -la *.html | grep -v google37cf596a386f6881.html || echo "No se encontraron archivos HTML"
          
          for file in *.html; do
            if [ -f "$file" ] && [ "$file" != "google37cf596a386f6881.html" ]; then
              echo "ðŸ“„ Minificando: $file"
              npx --yes html-minifier-terser \
                --collapse-whitespace \
                --remove-comments \
                --remove-redundant-attributes \
                --minify-css false \
                --minify-js false \
                -o "dist/$file" "$file" || cp "$file" "dist/$file"
              echo "âœ… HTML: $file"
            fi
          done
          
          # Minificar HTML de servicios
          echo "ðŸ“‹ Archivos HTML en servicios:"
          ls -la servicios/*.html 2>/dev/null || echo "No se encontraron archivos en servicios/"
          
          mkdir -p dist/servicios
          for file in servicios/*.html; do
            if [ -f "$file" ]; then
              echo "ðŸ“„ Minificando: $file"
              npx --yes html-minifier-terser \
                --collapse-whitespace \
                --remove-comments \
                --remove-redundant-attributes \
                --minify-css false \
                --minify-js false \
                -o "dist/$file" "$file" || cp "$file" "dist/$file"
              echo "âœ… HTML servicios: $file"
            fi
          done
          
          echo "ðŸ“ PASO 5: Copiar assets"
          # ImÃ¡genes
          if [ -d img ]; then
            find img -name "*.jpg" -o -name "*.jpeg" -o -name "*.png" -o -name "*.webp" -o -name "*.gif" | while read file; do
              mkdir -p "dist/$(dirname "$file")"
              cp "$file" "dist/$file"
            done
            [ -d img/favicon ] && cp -r img/favicon dist/img/ || true
            [ -d img/social ] && cp -r img/social dist/img/ || true
          fi
          
          # Fuentes
          if [ -d fonts ]; then
            find fonts -name "*.ttf" -o -name "*.otf" -o -name "*.woff" -o -name "*.woff2" | while read file; do
              mkdir -p "dist/$(dirname "$file")"
              cp "$file" "dist/$file"
            done
          fi
          
          echo "ðŸ—ºï¸ PASO 6: Actualizar sitemap"
          if [ -f sitemap.xml ]; then
            sed -i 's|contacto\.html|contacto|g' sitemap.xml
            sed -i 's|reserva-cita\.html|reserva-cita|g' sitemap.xml
            sed -i 's|terapia-individual\.html|terapia-individual|g' sitemap.xml
            sed -i 's|terapia-pareja\.html|terapia-pareja|g' sitemap.xml
            sed -i 's|neuropsicologia-clinica\.html|neuropsicologia-clinica|g' sitemap.xml
            sed -i 's|politica-privacidad\.html|politica-privacidad|g' sitemap.xml
            sed -i 's|politica-cookies\.html|politica-cookies|g' sitemap.xml
            sed -i 's|aviso-legal\.html|aviso-legal|g' sitemap.xml
            sed -i 's|consentimientoinformado\.html|consentimientoinformado|g' sitemap.xml
            cp sitemap.xml dist/
            echo "âœ… Sitemap actualizado"
          fi
          
          # Copiar archivos de configuraciÃ³n
          [ -f robots.txt ] && cp robots.txt dist/
          [ -f CNAME ] && cp CNAME dist/
          [ -f favicon.ico ] && cp favicon.ico dist/
          
          echo "ðŸŽ‰ BUILD COMPLETADO"
          echo "âœ… URLs convertidas a formato limpio (sin .html)"
          echo "âœ… Recursos con URLs absolutas" 
          echo "âœ… Archivos minificados"

      - name: Configure Git
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'actions@github.com'

      - name: Deploy to main branch
        run: |
          git checkout --orphan main || git checkout main
          git rm -rf . 2>/dev/null || true
          cp -r dist/* .
          git add .
          git commit -m "ðŸš€ Deploy con URLs optimizadas - $(date '+%Y-%m-%d %H:%M:%S')" || exit 0
          git push origin main --force
          echo "âœ… Sitio desplegado exitosamente"