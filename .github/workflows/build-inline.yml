name: Production Build - Simple & Reliable

on:
  push:
    branches: [ "source" ]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build and minify website
        run: |
          mkdir -p dist
          
          # Crear estructura de directorios
          mkdir -p dist/css dist/js dist/servicios dist/img dist/fonts dist/lib
          
          echo "ğŸ¨ Minificando CSS..."
          for file in css/*.css; do
            if [ -f "$file" ]; then
              npx --yes clean-css-cli -o "dist/$file" "$file" || cp "$file" "dist/$file"
              echo "âœ… CSS procesado: $file"
            fi
          done
          
          echo "âš¡ Minificando JavaScript..."
          for file in js/*.js; do
            if [ -f "$file" ]; then
              npx --yes terser "$file" -o "dist/$file" --compress --mangle || cp "$file" "dist/$file"
              echo "âœ… JS procesado: $file"
            fi
          done
          
          echo "ğŸ“„ Minificando HTML..."
          # PÃ¡ginas principales
          for file in *.html; do
            if [ -f "$file" ]; then
              npx --yes html-minifier-terser \
                --collapse-whitespace \
                --remove-comments \
                --remove-redundant-attributes \
                --minify-css false \
                --minify-js false \
                -o "dist/$file" "$file" || cp "$file" "dist/$file"
              echo "âœ… HTML procesado: $file"
            fi
          done
          
          # PÃ¡ginas de servicios
          if [ -d servicios ]; then
            for file in servicios/*.html; do
              if [ -f "$file" ]; then
                npx --yes html-minifier-terser \
                  --collapse-whitespace \
                  --remove-comments \
                  --remove-redundant-attributes \
                  --minify-css false \
                  --minify-js false \
                  -o "dist/$file" "$file" || cp "$file" "dist/$file"
                echo "âœ… HTML procesado: $file"
              fi
            done
          fi
          
          echo "ğŸ“ Copiando solo assets de producciÃ³n..."
          # Crear estructura de directorios para assets
          mkdir -p dist/img dist/fonts dist/lib
          
          # Copiar solo imÃ¡genes de producciÃ³n (excluir .DS_Store y carpetas de desarrollo)
          if [ -d img ]; then
            # Copiar imÃ¡genes principales
            find img -maxdepth 1 -name "*.jpg" -o -name "*.jpeg" -o -name "*.png" -o -name "*.webp" -o -name "*.gif" -o -name "*.svg" | while read file; do
              cp "$file" "dist/$file"
            done
            
            # Copiar solo favicon principal (no las carpetas de prueba)
            [ -d img/favicon ] && cp -r img/favicon dist/img/ || true
            [ -d img/social ] && cp -r img/social dist/img/ || true
            
            echo "âœ… ImÃ¡genes copiadas (excluyendo archivos de desarrollo)"
          fi
          
          # Copiar solo fuentes necesarias
          if [ -d fonts ]; then
            find fonts -name "*.ttf" -o -name "*.otf" -o -name "*.woff" -o -name "*.woff2" | while read file; do
              mkdir -p "dist/$(dirname "$file")"
              cp "$file" "dist/$file"
            done
          fi
          
          # Copiar solo librerÃ­as minificadas de producciÃ³n
          if [ -d lib ]; then
            find lib -name "*.min.js" -o -name "*.min.css" | while read file; do
              cp "$file" "dist/$file"
            done
            echo "âœ… LibrerÃ­as minificadas copiadas: $(find lib -name "*.min.*" | wc -l) archivos"
          fi
          
          # Copiar archivos de configuraciÃ³n
          [ -f robots.txt ] && cp robots.txt dist/ || true
          [ -f sitemap.xml ] && cp sitemap.xml dist/ || true
          [ -f CNAME ] && cp CNAME dist/ || true
          [ -f favicon.ico ] && cp favicon.ico dist/ || true
          
          echo "ğŸ“Š Build de producciÃ³n completado:"
          echo "âœ… CSS minificados: $(find dist/css -name "*.css" 2>/dev/null | wc -l) archivos"
          echo "âœ… JS minificados: $(find dist/js -name "*.js" 2>/dev/null | wc -l) archivos"  
          echo "âœ… HTML optimizados: $(find dist -name "*.html" 2>/dev/null | wc -l) pÃ¡ginas"
          echo "âœ… ImÃ¡genes de producciÃ³n: $(find dist/img -type f 2>/dev/null | wc -l) archivos"
          echo "âœ… Fuentes: $(find dist/fonts -type f 2>/dev/null | wc -l) archivos"
          echo "âœ… LibrerÃ­as: $(find dist/lib -type f 2>/dev/null | wc -l) archivos"
          echo "ğŸ“ TamaÃ±o total optimizado: $(du -sh dist/ | cut -f1)"
          echo ""
          echo "ğŸš€ Solo archivos de producciÃ³n - Sin duplicados ni archivos de desarrollo"

      - name: Deploy to main branch
        uses: ad-m/github-push-action@v0.8.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: main
          force: true
          directory: dist