name: Production Build - Simple & Reliable

on:
  push:
    branches: [ "source" ]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build and minify website
        run: |
          mkdir -p dist
          
          # Crear estructura de directorios
          mkdir -p dist/css dist/js dist/servicios dist/img dist/fonts dist/lib
          
          echo "üé® Minificando CSS..."
          for file in css/*.css; do
            if [ -f "$file" ]; then
              npx --yes clean-css-cli -o "dist/$file" "$file" || cp "$file" "dist/$file"
              echo "‚úÖ CSS procesado: $file"
            fi
          done
          
          echo "‚ö° Minificando JavaScript..."
          for file in js/*.js; do
            if [ -f "$file" ]; then
              npx --yes terser "$file" -o "dist/$file" --compress --mangle || cp "$file" "dist/$file"
              echo "‚úÖ JS procesado: $file"
            fi
          done
          
          echo "üîó Convirtiendo URLs a absolutas y sin .html..."
          
          # Funci√≥n para convertir URLs en archivos HTML
          convert_urls_in_file() {
            local file="$1"
            echo "üîÑ Procesando URLs en: $file"
            
            # Convertir recursos (CSS, JS, im√°genes) a URLs absolutas
            sed -i 's|href="css/|href="https://www.carmenbarqueropsicologia.es/css/|g' "$file"
            sed -i 's|href="../css/|href="https://www.carmenbarqueropsicologia.es/css/|g' "$file"
            sed -i 's|src="js/|src="https://www.carmenbarqueropsicologia.es/js/|g' "$file"
            sed -i 's|src="../js/|src="https://www.carmenbarqueropsicologia.es/js/|g' "$file"
            sed -i 's|src="img/|src="https://www.carmenbarqueropsicologia.es/img/|g' "$file"
            sed -i 's|src="../img/|src="https://www.carmenbarqueropsicologia.es/img/|g' "$file"
            sed -i 's|srcset="img/|srcset="https://www.carmenbarqueropsicologia.es/img/|g' "$file"
            sed -i 's|srcset="../img/|srcset="https://www.carmenbarqueropsicologia.es/img/|g' "$file"
            
            # Convertir favicons y meta content
            sed -i 's|href="img/favicon/|href="https://www.carmenbarqueropsicologia.es/img/favicon/|g' "$file"
            sed -i 's|href="../img/favicon/|href="https://www.carmenbarqueropsicologia.es/img/favicon/|g' "$file"
            sed -i 's|content="img/|content="https://www.carmenbarqueropsicologia.es/img/|g' "$file"
            sed -i 's|content="../img/|content="https://www.carmenbarqueropsicologia.es/img/|g' "$file"
            sed -i 's|content="./img/|content="https://www.carmenbarqueropsicologia.es/img/|g' "$file"
            
            # CSS inline backgrounds
            sed -i "s|background-image: url('img/|background-image: url('https://www.carmenbarqueropsicologia.es/img/|g" "$file"
            sed -i 's|background-image: url("img/|background-image: url("https://www.carmenbarqueropsicologia.es/img/|g' "$file"
            
            # Convertir navegaci√≥n a URLs absolutas SIN .html
            # Inicio - tanto index.html como ../index.html van a la ra√≠z
            sed -i 's|href="index\.html"|href="https://www.carmenbarqueropsicologia.es/"|g' "$file"
            sed -i 's|href="../index\.html"|href="https://www.carmenbarqueropsicologia.es/"|g' "$file"
            
            # P√°ginas principales SIN .html
            sed -i 's|href="contacto\.html"|href="https://www.carmenbarqueropsicologia.es/contacto"|g' "$file"
            sed -i 's|href="../contacto\.html"|href="https://www.carmenbarqueropsicologia.es/contacto"|g' "$file"
            sed -i 's|href="reserva-cita\.html"|href="https://www.carmenbarqueropsicologia.es/reserva-cita"|g' "$file"
            sed -i 's|href="../reserva-cita\.html"|href="https://www.carmenbarqueropsicologia.es/reserva-cita"|g' "$file"
            sed -i 's|href="politica-privacidad\.html"|href="https://www.carmenbarqueropsicologia.es/politica-privacidad"|g' "$file"
            sed -i 's|href="../politica-privacidad\.html"|href="https://www.carmenbarqueropsicologia.es/politica-privacidad"|g' "$file"
            sed -i 's|href="consentimientoinformado\.html"|href="https://www.carmenbarqueropsicologia.es/consentimientoinformado"|g' "$file"
            sed -i 's|href="../consentimientoinformado\.html"|href="https://www.carmenbarqueropsicologia.es/consentimientoinformado"|g' "$file"
            
            # Servicios SIN .html
            sed -i 's|href="servicios/terapia-individual\.html"|href="https://www.carmenbarqueropsicologia.es/servicios/terapia-individual"|g' "$file"
            sed -i 's|href="servicios/terapia-pareja\.html"|href="https://www.carmenbarqueropsicologia.es/servicios/terapia-pareja"|g' "$file"
            sed -i 's|href="servicios/neuropsicologia-clinica\.html"|href="https://www.carmenbarqueropsicologia.es/servicios/neuropsicologia-clinica"|g' "$file"
            sed -i 's|href="terapia-individual\.html"|href="https://www.carmenbarqueropsicologia.es/servicios/terapia-individual"|g' "$file"
            sed -i 's|href="terapia-pareja\.html"|href="https://www.carmenbarqueropsicologia.es/servicios/terapia-pareja"|g' "$file"
            sed -i 's|href="neuropsicologia-clinica\.html"|href="https://www.carmenbarqueropsicologia.es/servicios/neuropsicologia-clinica"|g' "$file"
            
            # Enlaces generales a servicios/
            sed -i 's|href="servicios/|href="https://www.carmenbarqueropsicologia.es/servicios/|g' "$file"
            
            echo "‚úÖ URLs convertidas en: $file"
          }
          
          # Convertir URLs en p√°ginas principales
          for file in dist/*.html; do
            if [ -f "$file" ]; then
              convert_urls_in_file "$file"
            fi
          done
          
          # Convertir URLs en p√°ginas de servicios
          for file in dist/servicios/*.html; do
            if [ -f "$file" ]; then
              convert_urls_in_file "$file"
            fi
          done
          
          echo "üéØ URLs convertidas:"
          echo "‚úÖ Recursos: URLs absolutas (CSS, JS, im√°genes)"
          echo "‚úÖ Navegaci√≥n: URLs absolutas sin .html"
          echo "‚úÖ Inicio: https://www.carmenbarqueropsicologia.es/"

          # Convertir URLs del sitemap.xml
          if [ -f sitemap.xml ]; then
            echo "üìÑ Convirtiendo URLs del sitemap a formato limpio..."
            sed -i '' 's|<loc>https://www\.carmenbarqueropsicologia\.es/contacto\.html</loc>|<loc>https://www.carmenbarqueropsicologia.es/contacto</loc>|g' sitemap.xml
            sed -i '' 's|<loc>https://www\.carmenbarqueropsicologia\.es/reserva-cita\.html</loc>|<loc>https://www.carmenbarqueropsicologia.es/reserva-cita</loc>|g' sitemap.xml
            sed -i '' 's|<loc>https://www\.carmenbarqueropsicologia\.es/servicios/terapia-individual\.html</loc>|<loc>https://www.carmenbarqueropsicologia.es/servicios/terapia-individual</loc>|g' sitemap.xml
            sed -i '' 's|<loc>https://www\.carmenbarqueropsicologia\.es/servicios/terapia-pareja\.html</loc>|<loc>https://www.carmenbarqueropsicologia.es/servicios/terapia-pareja</loc>|g' sitemap.xml
            sed -i '' 's|<loc>https://www\.carmenbarqueropsicologia\.es/servicios/neuropsicologia-clinica\.html</loc>|<loc>https://www.carmenbarqueropsicologia.es/servicios/neuropsicologia-clinica</loc>|g' sitemap.xml
            sed -i '' 's|<loc>https://www\.carmenbarqueropsicologia\.es/politica-privacidad\.html</loc>|<loc>https://www.carmenbarqueropsicologia.es/politica-privacidad</loc>|g' sitemap.xml
            sed -i '' 's|<loc>https://www\.carmenbarqueropsicologia\.es/consentimientoinformado\.html</loc>|<loc>https://www.carmenbarqueropsicologia.es/consentimientoinformado</loc>|g' sitemap.xml
            cp sitemap.xml dist/
            echo "‚úÖ Sitemap actualizado con URLs limpias"
          fi

          # Copiar robots.txt
          if [ -f robots.txt ]; then
            cp robots.txt dist/
            echo "‚úÖ Robots.txt copiado"
          fi
          echo "‚úÖ Servicios: https://www.carmenbarqueropsicologia.es/servicios/terapia-individual"
          
          echo "üìÑ Minificando HTML..."
          # P√°ginas principales
          for file in *.html; do
            if [ -f "$file" ]; then
              npx --yes html-minifier-terser \
                --collapse-whitespace \
                --remove-comments \
                --remove-redundant-attributes \
                --minify-css false \
                --minify-js false \
                -o "dist/$file" "$file" || cp "$file" "dist/$file"
              echo "‚úÖ HTML procesado: $file"
            fi
          done
          
          # P√°ginas de servicios
          if [ -d servicios ]; then
            for file in servicios/*.html; do
              if [ -f "$file" ]; then
                npx --yes html-minifier-terser \
                  --collapse-whitespace \
                  --remove-comments \
                  --remove-redundant-attributes \
                  --minify-css false \
                  --minify-js false \
                  -o "dist/$file" "$file" || cp "$file" "dist/$file"
                echo "‚úÖ HTML procesado: $file"
              fi
            done
          fi
          
          echo "üìÅ Copiando solo assets de producci√≥n..."
          # Crear estructura de directorios para assets
          mkdir -p dist/img dist/fonts dist/lib
          
          # Copiar solo im√°genes de producci√≥n (excluir .DS_Store y carpetas de desarrollo)
          if [ -d img ]; then
            # Copiar im√°genes principales
            find img -maxdepth 1 -name "*.jpg" -o -name "*.jpeg" -o -name "*.png" -o -name "*.webp" -o -name "*.gif" -o -name "*.svg" | while read file; do
              cp "$file" "dist/$file"
            done
            
            # Copiar solo favicon principal (no las carpetas de prueba)
            [ -d img/favicon ] && cp -r img/favicon dist/img/ || true
            [ -d img/social ] && cp -r img/social dist/img/ || true
            
            echo "‚úÖ Im√°genes copiadas (excluyendo archivos de desarrollo)"
          fi
          
          # Copiar solo fuentes necesarias
          if [ -d fonts ]; then
            find fonts -name "*.ttf" -o -name "*.otf" -o -name "*.woff" -o -name "*.woff2" | while read file; do
              mkdir -p "dist/$(dirname "$file")"
              cp "$file" "dist/$file"
            done
          fi
          
          # NO copiar librer√≠as locales - usar solo CDN para producci√≥n
          # Las librer√≠as se cargan desde CDN para mejor performance y cache
          echo "‚úÖ Usando librer√≠as desde CDN - No se copian archivos locales"
          
          # Copiar archivos de configuraci√≥n
          [ -f robots.txt ] && cp robots.txt dist/ || true
          [ -f sitemap.xml ] && cp sitemap.xml dist/ || true
          [ -f CNAME ] && cp CNAME dist/ || true
          [ -f favicon.ico ] && cp favicon.ico dist/ || true
          
          # Limpiar archivos de desarrollo y debug
          find dist -name ".DS_Store" -delete 2>/dev/null || true
          find dist -name "*.map" -delete 2>/dev/null || true
          find dist -name "*.log" -delete 2>/dev/null || true
          
          echo "üìä Build de producci√≥n completado (ULTRA LIMPIO):"
          echo "‚úÖ CSS minificados: $(find dist/css -name "*.css" 2>/dev/null | wc -l) archivos"
          echo "‚úÖ JS minificados: $(find dist/js -name "*.js" 2>/dev/null | wc -l) archivos"  
          echo "‚úÖ HTML optimizados: $(find dist -name "*.html" 2>/dev/null | wc -l) p√°ginas"
          echo "‚úÖ Im√°genes de producci√≥n: $(find dist/img -type f 2>/dev/null | wc -l) archivos"
          echo "‚úÖ Fuentes: $(find dist/fonts -type f 2>/dev/null | wc -l) archivos"
          echo "‚úÖ Usando librer√≠as desde CDN (no archivos locales)"
          echo "üìè Tama√±o total optimizado: $(du -sh dist/ | cut -f1)"
          echo ""
          echo "üöÄ PRODUCCI√ìN ULTRA LIMPIA - Sin archivos de desarrollo, debug o duplicados"

      - name: Deploy to main branch
        uses: ad-m/github-push-action@v0.8.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: main
          force: true
          directory: dist