name: Production Build - Simple & Reliable

on:
  push:
    branches: [ "source" ]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build and minify website
        run: |
          mkdir -p dist
          
          # Crear estructura de directorios
          mkdir -p dist/css dist/js dist/servicios dist/img dist/fonts dist/lib
          
          echo "ğŸ¨ Minificando CSS..."
          for file in css/*.css; do
            if [ -f "$file" ]; then
              npx --yes clean-css-cli -o "dist/$file" "$file" || cp "$file" "dist/$file"
              echo "âœ… CSS procesado: $file"
            fi
          done
          
          echo "âš¡ Minificando JavaScript..."
          for file in js/*.js; do
            if [ -f "$file" ]; then
              npx --yes terser "$file" -o "dist/$file" --compress --mangle || cp "$file" "dist/$file"
              echo "âœ… JS procesado: $file"
            fi
          done
          
          echo "ğŸ”— Convirtiendo URLs a absolutas y sin .html..."
          
          # FunciÃ³n para convertir URLs en archivos HTML
          convert_urls_in_file() {
            local file="$1"
            echo "ğŸ”„ Procesando URLs en: $file"
            
            # Convertir recursos (CSS, JS, imÃ¡genes) a URLs absolutas
            sed -i 's|href="css/|href="https://www.carmenbarqueropsicologia.es/css/|g' "$file"
            sed -i 's|href="../css/|href="https://www.carmenbarqueropsicologia.es/css/|g' "$file"
            sed -i 's|src="js/|src="https://www.carmenbarqueropsicologia.es/js/|g' "$file"
            sed -i 's|src="../js/|src="https://www.carmenbarqueropsicologia.es/js/|g' "$file"
            sed -i 's|src="img/|src="https://www.carmenbarqueropsicologia.es/img/|g' "$file"
            sed -i 's|src="../img/|src="https://www.carmenbarqueropsicologia.es/img/|g' "$file"
            sed -i 's|srcset="img/|srcset="https://www.carmenbarqueropsicologia.es/img/|g' "$file"
            sed -i 's|srcset="../img/|srcset="https://www.carmenbarqueropsicologia.es/img/|g' "$file"
            
            # Convertir favicons y meta content
            sed -i 's|href="img/favicon/|href="https://www.carmenbarqueropsicologia.es/img/favicon/|g' "$file"
            sed -i 's|href="../img/favicon/|href="https://www.carmenbarqueropsicologia.es/img/favicon/|g' "$file"
            sed -i 's|content="img/|content="https://www.carmenbarqueropsicologia.es/img/|g' "$file"
            sed -i 's|content="../img/|content="https://www.carmenbarqueropsicologia.es/img/|g' "$file"
            sed -i 's|content="./img/|content="https://www.carmenbarqueropsicologia.es/img/|g' "$file"
            
            # CSS inline backgrounds
            sed -i "s|background-image: url('img/|background-image: url('https://www.carmenbarqueropsicologia.es/img/|g" "$file"
            sed -i 's|background-image: url("img/|background-image: url("https://www.carmenbarqueropsicologia.es/img/|g' "$file"
            
            # Convertir navegaciÃ³n a URLs absolutas SIN .html
            # Inicio - tanto index.html como ../index.html van a la raÃ­z
            sed -i 's|href="index\.html"|href="https://www.carmenbarqueropsicologia.es/"|g' "$file"
            sed -i 's|href="../index\.html"|href="https://www.carmenbarqueropsicologia.es/"|g' "$file"
            
            # PÃ¡ginas principales SIN .html
            sed -i 's|href="contacto\.html"|href="https://www.carmenbarqueropsicologia.es/contacto"|g' "$file"
            sed -i 's|href="../contacto\.html"|href="https://www.carmenbarqueropsicologia.es/contacto"|g' "$file"
            sed -i 's|href="reserva-cita\.html"|href="https://www.carmenbarqueropsicologia.es/reserva-cita"|g' "$file"
            sed -i 's|href="../reserva-cita\.html"|href="https://www.carmenbarqueropsicologia.es/reserva-cita"|g' "$file"
            sed -i 's|href="politica-privacidad\.html"|href="https://www.carmenbarqueropsicologia.es/politica-privacidad"|g' "$file"
            sed -i 's|href="../politica-privacidad\.html"|href="https://www.carmenbarqueropsicologia.es/politica-privacidad"|g' "$file"
            sed -i 's|href="consentimientoinformado\.html"|href="https://www.carmenbarqueropsicologia.es/consentimientoinformado"|g' "$file"
            sed -i 's|href="../consentimientoinformado\.html"|href="https://www.carmenbarqueropsicologia.es/consentimientoinformado"|g' "$file"
            
            # Servicios SIN .html
            sed -i 's|href="servicios/terapia-individual\.html"|href="https://www.carmenbarqueropsicologia.es/servicios/terapia-individual"|g' "$file"
            sed -i 's|href="servicios/terapia-pareja\.html"|href="https://www.carmenbarqueropsicologia.es/servicios/terapia-pareja"|g' "$file"
            sed -i 's|href="servicios/neuropsicologia-clinica\.html"|href="https://www.carmenbarqueropsicologia.es/servicios/neuropsicologia-clinica"|g' "$file"
            sed -i 's|href="terapia-individual\.html"|href="https://www.carmenbarqueropsicologia.es/servicios/terapia-individual"|g' "$file"
            sed -i 's|href="terapia-pareja\.html"|href="https://www.carmenbarqueropsicologia.es/servicios/terapia-pareja"|g' "$file"
            sed -i 's|href="neuropsicologia-clinica\.html"|href="https://www.carmenbarqueropsicologia.es/servicios/neuropsicologia-clinica"|g' "$file"
            
            # Enlaces generales a servicios/
            sed -i 's|href="servicios/|href="https://www.carmenbarqueropsicologia.es/servicios/|g' "$file"
            
            echo "âœ… URLs convertidas en: $file"
          }
          
          # Convertir URLs en pÃ¡ginas principales
          for file in dist/*.html; do
            if [ -f "$file" ]; then
              convert_urls_in_file "$file"
            fi
          done
          
          # Convertir URLs en pÃ¡ginas de servicios
          for file in dist/servicios/*.html; do
            if [ -f "$file" ]; then
              convert_urls_in_file "$file"
            fi
          done
          
          echo "ğŸ¯ URLs convertidas:"
          echo "âœ… Recursos: URLs absolutas (CSS, JS, imÃ¡genes)"
          echo "âœ… NavegaciÃ³n: URLs absolutas sin .html"
          echo "âœ… Inicio: https://www.carmenbarqueropsicologia.es/"

          # Convertir URLs del sitemap.xml
          if [ -f sitemap.xml ]; then
            echo "ğŸ“„ Convirtiendo URLs del sitemap a formato limpio..."
            sed -i 's|contacto\.html|contacto|g' sitemap.xml
            sed -i 's|reserva-cita\.html|reserva-cita|g' sitemap.xml
            sed -i 's|terapia-individual\.html|terapia-individual|g' sitemap.xml
            sed -i 's|terapia-pareja\.html|terapia-pareja|g' sitemap.xml
            sed -i 's|neuropsicologia-clinica\.html|neuropsicologia-clinica|g' sitemap.xml
            sed -i 's|politica-privacidad\.html|politica-privacidad|g' sitemap.xml
            sed -i 's|consentimientoinformado\.html|consentimientoinformado|g' sitemap.xml
            cp sitemap.xml dist/
            echo "âœ… Sitemap actualizado con URLs limpias"
          fi

          # Copiar robots.txt
          if [ -f robots.txt ]; then
            cp robots.txt dist/
            echo "âœ… Robots.txt copiado"
          fi
          echo "âœ… Servicios: https://www.carmenbarqueropsicologia.es/servicios/terapia-individual"
          
          echo "ğŸ“„ Minificando HTML..."
          # PÃ¡ginas principales
          for file in *.html; do
            if [ -f "$file" ]; then
              npx --yes html-minifier-terser \
                --collapse-whitespace \
                --remove-comments \
                --remove-redundant-attributes \
                --minify-css false \
                --minify-js false \
                -o "dist/$file" "$file" || cp "$file" "dist/$file"
              echo "âœ… HTML procesado: $file"
            fi
          done
          
          # PÃ¡ginas de servicios
          if [ -d servicios ]; then
            for file in servicios/*.html; do
              if [ -f "$file" ]; then
                npx --yes html-minifier-terser \
                  --collapse-whitespace \
                  --remove-comments \
                  --remove-redundant-attributes \
                  --minify-css false \
                  --minify-js false \
                  -o "dist/$file" "$file" || cp "$file" "dist/$file"
                echo "âœ… HTML procesado: $file"
              fi
            done
          fi
          
          echo "ğŸ“ Copiando solo assets de producciÃ³n..."
          # Crear estructura de directorios para assets
          mkdir -p dist/img dist/fonts dist/lib
          
          # Copiar solo imÃ¡genes de producciÃ³n (excluir .DS_Store y carpetas de desarrollo)
          if [ -d img ]; then
            # Copiar imÃ¡genes principales
            find img -maxdepth 1 -name "*.jpg" -o -name "*.jpeg" -o -name "*.png" -o -name "*.webp" -o -name "*.gif" -o -name "*.svg" | while read file; do
              cp "$file" "dist/$file"
            done
            
            # Copiar solo favicon principal (no las carpetas de prueba)
            [ -d img/favicon ] && cp -r img/favicon dist/img/ || true
            [ -d img/social ] && cp -r img/social dist/img/ || true
            
            echo "âœ… ImÃ¡genes copiadas (excluyendo archivos de desarrollo)"
          fi
          
          # Copiar solo fuentes necesarias
          if [ -d fonts ]; then
            find fonts -name "*.ttf" -o -name "*.otf" -o -name "*.woff" -o -name "*.woff2" | while read file; do
              mkdir -p "dist/$(dirname "$file")"
              cp "$file" "dist/$file"
            done
          fi
          
          # NO copiar librerÃ­as locales - usar solo CDN para producciÃ³n
          # Las librerÃ­as se cargan desde CDN para mejor performance y cache
          echo "âœ… Usando librerÃ­as desde CDN - No se copian archivos locales"
          
          # Copiar archivos de configuraciÃ³n
          [ -f robots.txt ] && cp robots.txt dist/ || true
          [ -f sitemap.xml ] && cp sitemap.xml dist/ || true
          [ -f CNAME ] && cp CNAME dist/ || true
          [ -f favicon.ico ] && cp favicon.ico dist/ || true
          
          # Limpiar archivos de desarrollo y debug
          find dist -name ".DS_Store" -delete 2>/dev/null || true
          find dist -name "*.map" -delete 2>/dev/null || true
          find dist -name "*.log" -delete 2>/dev/null || true
          
          echo "ğŸ“Š Build de producciÃ³n completado (ULTRA LIMPIO):"
          echo "âœ… CSS minificados: $(find dist/css -name "*.css" 2>/dev/null | wc -l) archivos"
          echo "âœ… JS minificados: $(find dist/js -name "*.js" 2>/dev/null | wc -l) archivos"  
          echo "âœ… HTML optimizados: $(find dist -name "*.html" 2>/dev/null | wc -l) pÃ¡ginas"
          echo "âœ… ImÃ¡genes de producciÃ³n: $(find dist/img -type f 2>/dev/null | wc -l) archivos"
          echo "âœ… Fuentes: $(find dist/fonts -type f 2>/dev/null | wc -l) archivos"
          echo "âœ… Usando librerÃ­as desde CDN (no archivos locales)"
          echo "ğŸ“ TamaÃ±o total optimizado: $(du -sh dist/ | cut -f1)"
          echo ""
          echo "ğŸš€ PRODUCCIÃ“N ULTRA LIMPIA - Sin archivos de desarrollo, debug o duplicados"

      - name: Deploy to main branch
        uses: ad-m/github-push-action@v0.8.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: main
          force: true
          directory: dist